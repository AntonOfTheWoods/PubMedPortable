=========
PubMed2Go
=========

************
Requirements
************

- PubMed2Go processes XML files that can be downloaded from NCBI and builds up a PostgreSQL database containing all abstracts of the data set (no full texts).

- Furthermore, PubMed2Go generates a full text index with Xapian such that titles, abstracts, keywords, MeSH terms and substances can be queried with search terms.

- It is scalable to your system requirements using multiprocessing and can be modified easily to your personal needs.

- This documentation refers to a text mining example using the disease pancreatic cancer. It contains many small examples how to use PostgreSQL and Xapian as well as connecting both with small Python programmes. The default values in the scripts refer to the parameters given here, but all of them can be changed by the user. 

- If the examples from this documentations are used, there will be around 670 MB of disk space needed. There are no other hardware requirements.

- Start by copying the whole project folder from GitHub to your local disk.

------
Ubuntu
------

These are the packages that need to be installed to use PubMed2Go:

- python>=2.7.3

- postgresql>=8.4

- python-xappy>=0.5

- apt-xapian-index>=0.44

- python-xapian>=1.2.8

- python-sqlalchemy>=0.7.4

- python-psycopg2>=2.4.5 (dependency from SQLAlchemy)

- If there is not yet a superuser for the PostgreSQL database, create one with the name of your local account:

    - sudo -u postgres createuser \--superuser <user_name>

    - sudo -u <user_name> psql template1
    
       - \\password <press enter, type in password, and press enter, again>

       - \\q

- Now, you can connect to the standard PostgreSQL database "postgres" with PGAdmin3 or via command-line:

    - psql -h localhost -d postgres -U <user_name>


-------
Windows
-------

- <will follow soon>


------
Fedora
------

- <will follow soon>


*******************
Download a Data Set
*******************

- Type in the following URL into your browser and search for "pancreatic cancer":

    - http://www.ncbi.nlm.nih.gov/pubmed/

    - The quote signs are important for the exact search.

    - Click on "Send to:" and "File" and select "XML".

    - 10th July 2014: 21482 PubMed-IDs

        - Some PubMed-IDs might change over time. Even for the given example list of PubMed-IDs for this documentation in "data/pubmed_result.txt" it is possible, that you receive another number of downloaded publications in your XML files as well as different outcomes in the ongoing analyes.

    - The download of around 230 MB can take up to one hour depending on the time of day and internet connection. 

- Another possibility is to download PubMed articles with EFetch:

    - How to build a query:

        - http://www.ncbi.nlm.nih.gov/books/NBK25499/#chapter4.EFetch

        - http://www.ncbi.nlm.nih.gov/books/NBK25501/

    - You can also download only the PubMed-ID list from your browser by selecting "PMID List" instead of "XML" and then use EFetch (tested only on Ubuntu):

        - Change into the directory "data" in your command-line and type in "python generate_efetch.py". It will build the script "efetch.sh" which generates XML files with 100 PubMed-IDs in each document.

        - The standard input filename is "pubmed_result.txt" and the block size of PubMed-IDs for one XML file is 100, but this can be changed. Type in "python generate_efetch.py -h" to show adjustable parameters.

        - If you want to specify the name of the directory where the XML files should be saved, use parameter "-d" and create this folder manually before.

        - The file "data/pubmed_result.txt" contains 21482 PubMed-IDs and the first 100 PubMed-IDs are saved in "data/pancreatic_cancer_example/medline_00000000.xml" as an example.

        - Make "efetch.sh" executable with "chmod +x efetch.sh" in the command-line and run it in a folder of your choice by typing in "./efetch.sh".

        - This will be faster than using the browser to download a single XML file and it has the advantage of using multiprocessing in the next step as the script generates XML files with 100 titles in each document. The command also works with blocks of 500 PubMed-IDs, but not 1000.

- It is also possible to download the whole MEDLINE/PubMed via license:

    - http://www.nlm.nih.gov/databases/license/license.html

    - http://www.nlm.nih.gov/bsd/licensee/2013_stats/baseline_doc.html

- You can insert the XML files in an extra directory in your project folder "data" or somewhere else. The only important thing is to use only one type of topic or XML files in one folder, because the programme will insert all files of type XML in a directory into the database given (next step).


********************************************
Build up a Relational Database in PostgreSQL
********************************************

- Open a Terminal and type in:

    - psql template1

- Now enter the following commands into psql prompt to create a database and and a standard user:

    - CREATE USER parser WITH PASSWORD \'parser\'; <parser in single quotes>
    
    - CREATE DATABASE pancreatic_cancer_db;
    
    - GRANT ALL PRIVILEGES ON DATABASE pancreatic_cancer_db to parser;
    
    - \\q

- If you want to use another database name, just change "pancreatic_cancer_db" in these commands and provide this name in all other scripts by choosing the right parameter.

- Start loading the data from PubMed into your PostgreSQL database:

    - ./create_database.sh <path/to/input/files> <optional: database name> <optional: # processors> <optional: "noTables" if complete PostgreSQL schema already exists>

    - The default database name is "pancreatic_cancer_db" and the default number of processors is 2. If you only want to change the number of processors, you also have to enter the database name keeping the order of parameters as it is shown.

    - It is important that you only type in the name of the folder containing all XML files, but not the name of the file(s). This parameter is mandatory. You do not need to type in the absolute path. Suppose, you have saved your XML file(s) in the directory "data/pancreatic_cancer", use this command to run it with 4 processors and the database "pancreatic_cancer_db":

        - ./create_database.sh data/pancreatic_cancer pancreatic_cancer_db 4

        - If you get an error concerning too many database connections, activate the sleep command in line 77 and 79 in "create_database.sh" that is commented out. Sometimes the database connections are closed by the programme, but still remain open for some seconds, preventing the new programme to open a connection. You can also increase the number of possible connections to your PostgreSQL server that can be opened (Ubuntu: "max_connections = <type in number>" in "/etc/postgresql/<version number>/main/postgresql.conf").

    - While running the script "create_database.sh", you will be asked once for the password "parser" referring to the PostgreSQL user "parser". If you want to load new data into the database, but it is already created, you do not need to delete it and recreate it, again. Just change your command like this:

        - ./create_database.sh data/pancreatic_cancer pancreatic_cancer_db 4 noTables

    - For one file with around 230 MB this takes around 10 min (only one processor can be used). For the same amount of data split into files with only 100 PubMed-IDs (use "generate_efetch.py") it takes around 3 min with 4 processors (2,83 GHz and 8 GB RAM).

- Now, a schema "pubmed" exists in your database "pancreatic_cancer_db" that contains all abstracts, titles, authors, etc. More information will be given in section 5, containing SQL queries and small programming examples.


****************************************************
Build up a Full Text Index with Xapian and Search It
****************************************************

- The results from this section can be found in "full_text_index/results/results_from_documentation/".

- Change into the directory "full_text_index" in your terminal.

- Create two directories, "xapian" and "results", if they do not yet exist.

- Type in "python RunXapian.py -h" to get a help screen with all adjustable parameters.

- If you use all default values from this documentation, you will receive results in "results/results.csv" with "python RunXapian.py -x".

    - This command indexes all titles, abstracts, keywords, MeSH terms and substances from year 1809 to 2014, downloaded as XML files from PubMed (as described in section "Download a Data Set"). 

        - There are no abstracts with a publication date before 1809:

        - http://www.nlm.nih.gov/bsd/licensee/2014_stats/baseline_med_filecount.html

    - After completing the step of generating the full text index, the programme searches it the synonyms given in "synonyms/pancreatic_cancer.txt".

    - The output in the command-line shows how many PubMed-IDs are indexed (21482) and how many synonyms are searched (86).

    - This takes around 2 min on a 2,83 GHz machine with 8 GB RAM.

    - You can also select single years for indexing and searching.

    - If you just want to index your XML files, type in "python RunXapian.py -x -f". (Parameter "-f" turns off the search function of the programme, default is "True".) 

    - If you just want to search your synonyms, type in "python RunXapian.py" (Parameter "-x" turns on the indexing step, default is "False".)

- For the given example, 9299 lines were generated in "results.csv". Run "python summary.py" to get two CSV files in directory "results". If you have chosen another filename as output from "RunXapian.py", you can do "python summary.py -f <name_of_input_file.csv>":

    - Drug synonyms were taken from DrugBank using the exact search query "pancreatic cancer":

        - http://www.drugbank.ca/

    - Protein and gene synonyms have been extracted manually from OMIM also performing an exact search:

        - http://omim.org/entry/260350?search=%22pancreatic%20cancer%22

    - Other diseases related to pancreatic cancer have been taken the text given on OMIM, too.

    - "counts_results.csv" shows how many synonyms were found (descending - 64 lines, meaning 64 from a total of 86 search terms). The alternative input filename will be "counts_<input_file.csv>".

        - Taking into account the drugs, gemcitabine shows the most hits (2644). Erlotinib was found in 280 publications. Other approved drugs like WF10 and hydroxocobalamin were not found. Many investigational drugs were found 1-10 times: R115777, G17DT, hedgehog pathway inhibitor, imexon, GV1001, RP101, MGI-114, and PX-12. No other substances given on DrugBank were identified in this data set.

        - Pancreatic ductal adenocarcinoma is the most common type of pancreatic cancer ( http://www.cancer.gov/aboutnci/budget_planning_leg/plan-2013/profiles/pancreatic ), which is shown by the 1333 hits. The tumor suppressor protein p53 was found 620 times, but also associated genes like KRAS, SMAD4, BRCA2, mTOR and CDKN2A were found (122-344 times). Many other genes were identified with a number below 10 hits and can be further analysed in "pmids_results.csv".

        - Associated diseases like breast cancer, colon cancer, ovarian cancer and diabetes were found 230-36 times.

    - "pmids_results.csv" shows which synonyms co-occur in the same abstract or title, sorted by PubMed-IDs (6745 lines). In case of an alternative input filename, there will be the resulting file "pmids_<input_file.csv>".

- In case, you want to index the whole PubMed, it can be useful to index blocks of years or every year as a single directory. Like this, it is possible to use multiprocessing and decrease RAM usage. Just run the programme in different shells or on different machines and copy all resulting index folders to the same main directory. The tool "xapian-compact" summarises all generated directories to one full text index:

    - http://xapian.org/docs/admin_notes.html#merging-databases

    - xapian-compact -m  <all input directories to be compressed, separated by space> <name of outcoming folder with complete database>


******************************************************************************
Examples for Connecting Full Text Search and Selection of Data from PostgreSQL
******************************************************************************

------
Xapian
------

- Use the following scripts to work with the functions OR, AND, NEAR, ADJ, NOT, and phrase search in Xapian and have a look at the HTML output files. As the number of PubMed-IDs increases continuously, the resulting numbers in this documentation can be seen as a reference point for the given query "pancreatic cancer". Having a look at these scripts as well as "RunXapian.py" can be useful to build your own modified queries. There is also a small note in "full_text_index/xapian/readme.txt".

    - "python search_title.py" shows that only a few lines of code are required to search only publication titles. This can be important as searching especially in publication titles puts more emphasis on the queried synonyms.

        - While "RunXapian.py" searches only the exact phrase "pancreatic cancer", "search_title.py" searches for the stem "pancreat" and also finds the word "pancreatitis".

        - It generates "Xapian_query_results.html" which shows the first 1000 of 16674 titles. Like this, many associated words are shown, e.g. "pancreatic ductal adenocarcinoma" or "pancreatic diseases".

    - To further specify your search, you can query titles containing "pancreatic cancer" and the drug "erlotinib" with "python search_near_title.py".

        - This generates 32 results in "Xapian_query_results_NEAR.html".

        - In this case "NEAR/5" is used as a Xapian function. "NEAR" is keeping the synonym order, but only a maximum of 4 words is allowed to be between the two search terms.

        - An alternative would be the query with "ADJ/5", which reduces the number of 32 hits, because with this function, the order of search terms is fixed.

        - Here, the exact search is performed, again.

    - As it was done in "RunXapian.py" different index fields can be searched. 

        - "python search_title_or_text.py" searches documents in which the drug "R115777" occurs in the title or the text. 

        - As shown in "counts_results.csv", only 10 hits can be found. The matching titles and abstracts can be seen in "Xapian_query_results_OR.html".

    - The script "python search_not_title_or_text.py" specifies the query to documents not containing the terms "colon", "lung", or "ovarian", but the word "pancreatic".

        - This reduces the number of results to 9 hits, as no publications are considered that contain these other types of cancer.

        - The result is shown in "Xapian_query_results_NOT.html".

    - In this way, different search queries can be combined with a few lines of code.


----------
PostgreSQL
----------

- Type in these SQL queries in PGAdmin3 or in the PostgreSQL shell to get familiar with the schema "pubmed":

    - Find all substances related to pancreatic cancer, pancreatitis, etc.

        - select * from pubmed.tbl_chemical where lower(name_of_substance) LIKE \'pancreati%\'; \-- 177 lines
    
    - Find all MeSH terms with the substring "ancreat" and prefixes as well as suffixes.

        - select distinct on (descriptor_name) * from pubmed.tbl_mesh_heading where lower(descriptor_name) LIKE \'%ancreat%\'; \-- 29 lines

    - What is the number of published titles in our database?

        - select count(*) from pubmed.tbl_medline_citation; \-- 21482

    - How many publications contain an abstract?

        - select count(*) from pubmed.tbl_abstract; \-- 19726
    
    - Show me all different journals and abbreviations referring to our topic.

        - select distinct on (title, iso_abbreviation) title, iso_abbreviation from pubmed.tbl_journal; \-- 2096 lines

    - What is the number of publications since 1990?

        - select count(*) from pubmed.tbl_journal where pub_date_year <=2000 and pub_date_year >=1990; \-- between 1990 and 2000: 3736 publications

        - select count(*) from pubmed.tbl_journal where pub_date_year <=2010 and pub_date_year >2000; \-- after 2000 until 2010: 9286 publications
    
        - select count(*) from pubmed.tbl_journal where pub_date_year >2010; \-- after 2010: 6898 publications

    - What is the number of publications in USA referring to our topic?

        - select count(*) from pubmed.tbl_medline_journal_info where lower(country) = \'united states\'; \-- 9304 publications

    - I took the first publication for our query "pancreatic cancer" in the browser on NCBI and wanted to know whether this author has other publications. For our data set, this is not the case, because the query result is "1".

        - select count (*) from pubmed.tbl_author where last_name = \'Iswanto\'; \-- 1 line


---------------------
PostgreSQL and Xapian
---------------------

- The results of this subsection can be found in "full_text_index/results/results_from_documentation/".

- Try "python find_authors.py" to see an example for processing a PostgreSQL query in Python. Use "python find_authors.py -f <output_filename> -d <name_of_database>" to specify the name of the output file and the database to connect to. "python find_authors.py -h" shows all adjustable parameters.

    - Considering the output, Ralph H. Hruban has published the most articles with a number of 237 PubMed-IDs.

        - The other authors and their number of publications can be found in "results/authors.csv" in a descending order.

    - You can check the amount of publications from similiarly written author names in PGAdmin3 and then Helmut Friess is shown as the one with the most publications:

        - select distinct on(fk_pmid) * from pubmed.tbl_author where last_name = \'Friess\' and (fore_name = \'H\' or fore_name = \'Helmut\') order by fk_pmid; \-- 370

        - select distinct on(fk_pmid) * from pubmed.tbl_author where last_name = \'Büchler\' and (fore_name = \'Markus W\' or fore_name = \'M W\') order by fk_pmid; \-- 302

        - select distinct on(fk_pmid) * from pubmed.tbl_author where last_name = \'Hruban\' and fore_name = \'Ralph H\'; \-- 237

    - It is possible that an author name exists twice although different persons are meant. This is not considered here.

    - There are examples in which you can only find a collective name:

        - select * from pubmed.tbl_author where last_name is NULL and fore_name is NULL; \-- 249

- Based on this, it is possible to consider whether the author Helmut Friess has published something containing the query terms from the list in "synonyms/pancreatic_cancer.txt":

    - Type in "python find_topics.py". You can try "python find_topics.py -h", to see which parameters can be varied, e.g. if your input filename is not "pmids_results.csv" or if you want to specify your output filename, which default is "pmids_results_from_author.csv".

        - 123 publications were found for the given list of synonyms and this author.

        - The main research topic seems to be pancreatic ductal adenocarcinoma. This result can be compared with the outputs using other author names (hard coded in "find_topics.py") and running "find_topics.py" with another filename, again.

- Next steps can be to select the abstracts that were identified with Xapian from PostgreSQL and to use a sentence tokeniser. Like this, groups of words and semantic structures can be analysed with natural language processing methods. 


*******
Contact
*******

- Please, write an e-mail, if you have questions, feedback, improvements, or new ideas:

    - kersten.doering@pharmazie.uni-freiburg.de

- If you are interested in related projects, visit our working group's homepage:

    - http://www.pharmaceutical-bioinformatics.de

-------
License
-------

- PubMed2Go is published with an ISC license given in "license.txt".
